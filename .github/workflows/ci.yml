name: CI

on:
  push:
    branches: [ main, dev, feat/**, fix/** ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        features: ["", "introspection", "net", "introspection,net"]
    env:
      RUST_BACKTRACE: 1
      RUSTFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - name: Show toolchain
        run: rustc -Vv && cargo -V
      - name: Install rustfmt
        run: rustup component add rustfmt
      - name: Format check (workspace)
        run: cargo fmt --all -- --check
      - name: Test (${{ matrix.features }})
        shell: bash
        run: |
          if [[ "${{ matrix.features }}" == "" ]]; then
            cargo test --all-targets
          else
            cargo test --all-targets --features "${{ matrix.features }}"
          fi
      - name: Dependency Duplicates (cargo tree -d)
        shell: bash
        run: |
          if [[ "${{ matrix.features }}" == "" ]]; then
            cargo tree -d || true
          else
            cargo tree -d --features "${{ matrix.features }}" || true
          fi
      - name: Install clippy
        run: rustup component add clippy
      - name: Clippy (${{ matrix.features }})
        shell: bash
        run: |
          if [[ "${{ matrix.features }}" == "" ]]; then
            cargo clippy --all-targets -- -D warnings
          else
            cargo clippy --all-targets --features "${{ matrix.features }}" -- -D warnings
          fi
  msrv-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        features: ["", "introspection", "net", "introspection,net"]
    env:
      RUST_BACKTRACE: 1
      RUSTFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@1.100.0
      - name: Show toolchain
        run: rustc -Vv && cargo -V
      - name: Test (${{ matrix.features }})
        shell: bash
        run: |
          if [[ "${{ matrix.features }}" == "" ]]; then
            cargo test --all-targets
          else
            cargo test --all-targets --features "${{ matrix.features }}"
          fi
      - name: Install clippy
        run: rustup component add clippy
      - name: Clippy (${{ matrix.features }})
        shell: bash
        run: |
          if [[ "${{ matrix.features }}" == "" ]]; then
            cargo clippy --all-targets -- -D warnings
          else
            cargo clippy --all-targets --features "${{ matrix.features }}" -- -D warnings
          fi
